<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>å€‹äººä¸»é </title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h2>å€‹äººä¸»é </h2>
        <div class="profile-card">
            {% if profile.avatar_blob %}
                <img src="{{ url_for('user_avatar', user_id=profile.id) }}" alt="å¤§é ­è²¼" class="avatar profile-avatar">
            {% elif profile.avatar %}
                <img src="{{ profile.avatar }}" alt="å¤§é ­è²¼" class="avatar profile-avatar">
            {% else %}
                <p>å°šæœªä¸Šå‚³å¤§é ­è²¼</p>
            {% endif %}
            <p><strong>ä½¿ç”¨è€…ï¼š</strong> {{ profile.display_name }}</p>
            <p><strong>é€£çºŒé‹å‹•å¤©æ•¸ï¼š</strong> {{ profile.streak_days }} å¤©</p>
        </div>

        <div class="profile-badges">
            <h3>å·²ç²å¾½ç« </h3>
            {% if earned_badges and earned_badges|length > 0 %}
            <ul class="badges-grid small">
                {% for b in earned_badges %}
                <li>
                    {% if b.image %}
                    <img src="{{ b.image }}" alt="{{ b.title }}" style="width:48px;height:48px;object-fit:contain">
                    {% else %}
                    <div class="badge-img placeholder">ğŸ…</div>
                    {% endif %}
                    <div style="display:inline-block; vertical-align:top; margin-left:8px;">
                        <div><strong>{{ b.title }}</strong></div>
                        <div class="small">{{ b.earned_at.strftime('%Y-%m-%d') if b.earned_at else '' }}</div>
                    </div>
                    {% if profile.username == current_user.username %}
                    <div style="margin-left:8px; display:inline-block;">
                        <button class="btn small pin-btn" data-badge-title="{{ b.title }}">æ›ä¸Š</button>
                    </div>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p>å°šæœªç²å¾—å¾½ç« </p>
            {% endif %}
        </div>
        <div class="profile-settings">
            <h3>å€‹äººè¨­å®š</h3>
            <p style="text-align:center;">
                <a href="{{ url_for('settings_page') }}" class="btn">ç·¨è¼¯è¨­å®š</a>
                <a href="{{ url_for('logout') }}" class="btn">ç™»å‡º</a>
            </p>
        </div>

        <div class="profile-posts">
            <h3>æˆ‘çš„è²¼æ–‡</h3>
            {% for p in posts %}
                <div class="post">
                    <div class="post-header" style="position:relative;">
                        <strong>{{ p.created_at }}</strong>
                        {% if current_user.is_authenticated and current_user.id == profile.id %}
                        <div class="post-menu" data-post-id="{{ p.id }}">
                            <button class="post-menu-btn" aria-label="æ›´å¤šé¸é …">â‹¯</button>
                            <ul class="post-menu-list" style="display:none;">
                                <li class="post-menu-edit"><a href="{{ url_for('edit_post', post_id=p.id) }}">ç·¨è¼¯</a></li>
                                <li class="post-menu-delete"><button class="post-menu-delete-btn">åˆªé™¤</button></li>
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                    <div class="post-body">
                        {% if p.sport or (p.minutes and p.minutes|int > 0) %}
                        <p>
                            {% if p.sport %}<strong>{{ p.sport }}</strong>{% endif %}
                            {% if p.sport and p.minutes and p.minutes|int > 0 %} â€¢ {% endif %}
                            {% if p.minutes and p.minutes|int > 0 %}{{ p.minutes }} åˆ†é˜{% endif %}
                        </p>
                        {% endif %}
                        {% if p.message %}<p>{{ p.message }}</p>{% endif %}
                        {% if p.image %}<img src="{{ p.image }}" class="post-image" style="max-width:200px;">{% endif %}
                        <div style="margin-top:6px;">
                            <!-- actions moved to top-right menu -->
                        </div>
                    </div>
                </div>
            {% else %}
                <p>å°šæœªæœ‰è²¼æ–‡</p>
            {% endfor %}
        </div>
    </div>

    <!-- Bottom nav (7 items) -->
    <div class="bottom-nav">
        <a href="{{ url_for('index') }}" class="nav-item">é¦–é </a>
        <a href="{{ url_for('friends_page') }}" class="nav-item">å¥½å‹</a>
        <a href="{{ url_for('profile_page') }}" class="nav-item">å€‹äºº</a>
        <a href="{{ url_for('checkin') }}" class="nav-item checkin-btn">æ‰“å¡</a>
        <a href="{{ url_for('leaderboard_page') }}" class="nav-item">æ’è¡Œæ¦œ</a>
        <a href="{{ url_for('stats') }}" class="nav-item">åˆ†æ</a>
        <a href="{{ url_for('badges_page') }}" class="nav-item">å¾½ç« </a>
    </div>
    <script>
    // simple client-side pin action: call pin endpoint
    document.addEventListener('click', function(e){
        if(e.target && e.target.classList.contains('pin-btn')){
            const btn = e.target;
            const title = btn.getAttribute('data-badge-title');
            // find badge by title in DOM -- this is a simple approach; server side mapping is stable
            fetch('/badge/pin', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({title:title})}).then(r=>r.json()).then(j=>{
                if(j.ok){
                    btn.textContent = 'å·²æ›ä¸Š';
                    btn.disabled = true;
                    alert('å¾½ç« å·²æ›ä¸Šï¼ˆæœ€å¤š 3 å€‹ï¼‰');
                } else {
                    alert('æ›ä¸Šå¤±æ•—: ' + (j.error||''));
                }
            })
        }
    })
    </script>
    <script src="{{ url_for('static', filename='app.js') }}"></script>
</body>
</html>
